CREATE TABLE ip_locations (
  ip_from bigint,
  ip_to bigint,
  country_code char(2),
  country_name text,
  region text,
  city text
);

# iconv -f iso-8859-1 -t utf8 IP-COUNTRY-REGION-CITY.CSV >ip-utf8.csv

\COPY ip_locations FROM 'ip-utf8.csv' WITH CSV QUOTE AS '"'
    
CREATE INDEX ip2location_range_gist ON ip_locations USING gist ((box(point(ip_from,ip_from),point(ip_to,ip_to))) box_ops);


ALTER TABLE ip_locations ADD COLUMN state_code char(2);
UPDATE IP_LOCATIONS SET STATE_CODE = 'AL' WHERE COUNTRY_CODE = 'US' AND REGION = 'ALABAMA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'AK' WHERE COUNTRY_CODE = 'US' AND REGION = 'ALASKA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'AZ' WHERE COUNTRY_CODE = 'US' AND REGION = 'ARIZONA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'AR' WHERE COUNTRY_CODE = 'US' AND REGION = 'ARKANSAS';
UPDATE IP_LOCATIONS SET STATE_CODE = 'CA' WHERE COUNTRY_CODE = 'US' AND REGION = 'CALIFORNIA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'CO' WHERE COUNTRY_CODE = 'US' AND REGION = 'COLORADO';
UPDATE IP_LOCATIONS SET STATE_CODE = 'CT' WHERE COUNTRY_CODE = 'US' AND REGION = 'CONNECTICUT';
UPDATE IP_LOCATIONS SET STATE_CODE = 'DE' WHERE COUNTRY_CODE = 'US' AND REGION = 'DELAWARE';
UPDATE IP_LOCATIONS SET STATE_CODE = 'DC' WHERE COUNTRY_CODE = 'US' AND REGION = 'DISTRICT OF COLUMBIA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'FL' WHERE COUNTRY_CODE = 'US' AND REGION = 'FLORIDA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'GA' WHERE COUNTRY_CODE = 'US' AND REGION = 'GEORGIA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'HI' WHERE COUNTRY_CODE = 'US' AND REGION = 'HAWAII';
UPDATE IP_LOCATIONS SET STATE_CODE = 'ID' WHERE COUNTRY_CODE = 'US' AND REGION = 'IDAHO';
UPDATE IP_LOCATIONS SET STATE_CODE = 'IL' WHERE COUNTRY_CODE = 'US' AND REGION = 'ILLINOIS';
UPDATE IP_LOCATIONS SET STATE_CODE = 'IN' WHERE COUNTRY_CODE = 'US' AND REGION = 'INDIANA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'IA' WHERE COUNTRY_CODE = 'US' AND REGION = 'IOWA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'KS' WHERE COUNTRY_CODE = 'US' AND REGION = 'KANSAS';
UPDATE IP_LOCATIONS SET STATE_CODE = 'KY' WHERE COUNTRY_CODE = 'US' AND REGION = 'KENTUCKY';
UPDATE IP_LOCATIONS SET STATE_CODE = 'LA' WHERE COUNTRY_CODE = 'US' AND REGION = 'LOUISIANA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'ME' WHERE COUNTRY_CODE = 'US' AND REGION = 'MAINE';
UPDATE IP_LOCATIONS SET STATE_CODE = 'MD' WHERE COUNTRY_CODE = 'US' AND REGION = 'MARYLAND';
UPDATE IP_LOCATIONS SET STATE_CODE = 'MA' WHERE COUNTRY_CODE = 'US' AND REGION = 'MASSACHUSETTS';
UPDATE IP_LOCATIONS SET STATE_CODE = 'MI' WHERE COUNTRY_CODE = 'US' AND REGION = 'MICHIGAN';
UPDATE IP_LOCATIONS SET STATE_CODE = 'MN' WHERE COUNTRY_CODE = 'US' AND REGION = 'MINNESOTA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'MS' WHERE COUNTRY_CODE = 'US' AND REGION = 'MISSISSIPPI';
UPDATE IP_LOCATIONS SET STATE_CODE = 'MO' WHERE COUNTRY_CODE = 'US' AND REGION = 'MISSOURI';
UPDATE IP_LOCATIONS SET STATE_CODE = 'MT' WHERE COUNTRY_CODE = 'US' AND REGION = 'MONTANA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'NE' WHERE COUNTRY_CODE = 'US' AND REGION = 'NEBRASKA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'NV' WHERE COUNTRY_CODE = 'US' AND REGION = 'NEVADA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'NH' WHERE COUNTRY_CODE = 'US' AND REGION = 'NEW HAMPSHIRE';
UPDATE IP_LOCATIONS SET STATE_CODE = 'NJ' WHERE COUNTRY_CODE = 'US' AND REGION = 'NEW JERSEY';
UPDATE IP_LOCATIONS SET STATE_CODE = 'NM' WHERE COUNTRY_CODE = 'US' AND REGION = 'NEW MEXICO';
UPDATE IP_LOCATIONS SET STATE_CODE = 'NY' WHERE COUNTRY_CODE = 'US' AND REGION = 'NEW YORK';
UPDATE IP_LOCATIONS SET STATE_CODE = 'NC' WHERE COUNTRY_CODE = 'US' AND REGION = 'NORTH CAROLINA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'ND' WHERE COUNTRY_CODE = 'US' AND REGION = 'NORTH DAKOTA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'OH' WHERE COUNTRY_CODE = 'US' AND REGION = 'OHIO';
UPDATE IP_LOCATIONS SET STATE_CODE = 'OK' WHERE COUNTRY_CODE = 'US' AND REGION = 'OKLAHOMA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'OR' WHERE COUNTRY_CODE = 'US' AND REGION = 'OREGON';
UPDATE IP_LOCATIONS SET STATE_CODE = 'PA' WHERE COUNTRY_CODE = 'US' AND REGION = 'PENNSYLVANIA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'RI' WHERE COUNTRY_CODE = 'US' AND REGION = 'RHODE ISLAND';
UPDATE IP_LOCATIONS SET STATE_CODE = 'SC' WHERE COUNTRY_CODE = 'US' AND REGION = 'SOUTH CAROLINA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'SD' WHERE COUNTRY_CODE = 'US' AND REGION = 'SOUTH DAKOTA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'TN' WHERE COUNTRY_CODE = 'US' AND REGION = 'TENNESSEE';
UPDATE IP_LOCATIONS SET STATE_CODE = 'TX' WHERE COUNTRY_CODE = 'US' AND REGION = 'TEXAS';
UPDATE IP_LOCATIONS SET STATE_CODE = 'UT' WHERE COUNTRY_CODE = 'US' AND REGION = 'UTAH';
UPDATE IP_LOCATIONS SET STATE_CODE = 'VT' WHERE COUNTRY_CODE = 'US' AND REGION = 'VERMONT';
UPDATE IP_LOCATIONS SET STATE_CODE = 'VA' WHERE COUNTRY_CODE = 'US' AND REGION = 'VIRGINIA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'WA' WHERE COUNTRY_CODE = 'US' AND REGION = 'WASHINGTON';
UPDATE IP_LOCATIONS SET STATE_CODE = 'WV' WHERE COUNTRY_CODE = 'US' AND REGION = 'WEST VIRGINIA';
UPDATE IP_LOCATIONS SET STATE_CODE = 'WI' WHERE COUNTRY_CODE = 'US' AND REGION = 'WISCONSIN';
UPDATE IP_LOCATIONS SET STATE_CODE = 'WY' WHERE COUNTRY_CODE = 'US' AND REGION = 'WYOMING';

# select distinct region from ip_locations where country_code = 'US' and state_code is null;
